<script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
<div class="header-bar">
    <div>
        <h1>Hola invera </h1>
        <!-- <h3 style="margin:0">You have <i>{{count}}</i> incomplete task{{ count|pluralize:"s" }}</h3> -->
        <h3 style="margin:0">Tareas pendientes: <i>1</i> </h3>
    </div>

    
</div>


<div id="search-add-wrapper">
    <form method="GET" style="display: flex;">
        <div id="new-task">
            <div style="flex:6; width:700px">
                <input type='text' name='search-area' placeholder="Buscar tarea">
            </div>
            <div style="flex:6">
                <input class="button" type="submit" value='Search'>
            </div>
        </div>
    </form>
   
</div>

<div id="new-task-wrapper" class="card-body">
    <form id="form" style="display: flex;">
        <div id="new-task">
            <div style="flex:6; width:700px">
                <input id="title" type='text' name='title' placeholder="Nueva tarea">
            </div>
            <div style="flex:6">
                <input class="button" type="submit" value="Submit">
            </div>
        </div>
    </form>
   
</div>


<!-- Hidden form. Form submits new item positions -->



<div id="tasklist" class="task-items-wrapper">
    
</div>

<script>
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                // Does this cookie string begin with the name we want?
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrftoken = getCookie('csrftoken');
    var taskList = document.getElementById("tasklist");
    
    // var reorderForm = document.getElementById("reorderForm");
    // var positionInput = document.getElementById("positionInput");
    buildList()
    function buildList(){
        taskList.innerHTML = ''
        var url = 'http://127.0.0.1:8000/api/task/list/'

        fetch(url)
        .then((resp) => resp.json())
        .then(function(data){
            for(var i in data){

                var item = `
                   
                <div class="task-wrapper" data-position="${data[i].id}">
                    <div class="task-title">
                        <div class="task-incomplete-icon"></div>
                        <a href="">${data[i].title}</a> 
                    </div>
                    <div class="task-controls">
                        <a class="delete-link" href="">&#215;</a>
                        <span class="handle">&nbsp;&#10247;</span>
                    </div>
                </div>
                `
                taskList.innerHTML += item
            }
        })
    }

    var form = document.getElementById("new-task-wrapper");
    form.addEventListener("submit", function(e){
        e.preventDefault();
        console.log("Boton funcionando")
        var url = 'http://127.0.0.1:8000/api/task/create/'
        var title = document.getElementById('title').value
    
        fetch(url,{
            method: 'POST',
            headers:{
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken,
            },
            body:JSON.stringify({'title':title})
        }).then(function(response){
            buildList()
            document.getElementById('form').reset()
        })
    })


    // let sortable = Sortable.create(taskList, {
    //     handle: '.handle',
    //     ghostClass: 'dropArea',
    //     chosenClass: 'selectedTask',

    // });

    // function reordering() {
    //     const rows = document.getElementsByClassName("task-wrapper");
    //     let pos = [];
    //     for (let row of rows) {
    //         pos.push(row.dataset.position);
    //     }
    //     console.log(pos.join(","))
    //     positionInput.value = pos.join(',');
    //     reorderForm.submit();
    // }

    // document.ondrop = reordering
</script>